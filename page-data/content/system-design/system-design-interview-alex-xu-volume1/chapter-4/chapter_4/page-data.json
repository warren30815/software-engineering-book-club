{
    "componentChunkName": "component---node-modules-gatsby-theme-primer-wiki-src-templates-post-query-js",
    "path": "/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4/",
    "result": {"data":{"mdx":{"id":"0ba8f94f-7c98-5458-af30-b7df8ccd10ef","tableOfContents":{"items":[{"url":"#第四章設計網路限速器","title":"第四章：設計網路限速器","items":[{"url":"#-主軸","title":"# 主軸"},{"url":"#-algorithm","title":"# Algorithm"},{"url":"#-high-level-architecture","title":"# High-level architecture"},{"url":"#-design-deep-dive","title":"# Design deep dive"},{"url":"#-延伸討論","title":"# 延伸討論"}]}]},"fields":{"title":"第四章：設計網路限速器","slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4/","url":"https://warren30815.github.io/software-engineering-book-club/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4/","editUrl":"https://github.com/warren30815/software-engineering-book-club/tree/main/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4.md","lastUpdatedAt":"2023-06-22T13:53:44.000Z","lastUpdated":"6/22/2023","gitCreatedAt":"2023-06-22T13:53:44.000Z","shouldShowTitle":false},"frontmatter":{"title":"","description":null,"imageAlt":null,"tags":[],"date":null,"dateModified":null,"language":null,"seoTitle":null,"image":null},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", {\n    \"id\": \"第四章設計網路限速器\"\n  }, \"\\u7B2C\\u56DB\\u7AE0\\uFF1A\\u8A2D\\u8A08\\u7DB2\\u8DEF\\u9650\\u901F\\u5668\"), mdx(\"h2\", {\n    \"id\": \"-主軸\"\n  }, \"# \\u4E3B\\u8EF8\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u4E3B\\u8981\\u5728 Layer 7: Application layer\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u4F5C\\u7528\\uFF1A\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u9632\\u6B62 DoS: \\u907F\\u514D\\u8CC7\\u6E90\\u9913\\u6B7B (resouce starvation)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u7BC0\\u7701\\u6D41\\u91CF\\u6210\\u672C: \\u6D41\\u7A0B\\u5167\\u53EF\\u80FD\\u6703\\u8ABF\\u7528\\u5230\\u7B2C\\u4E09\\u65B9\\u670D\\u52D9 (\\u4F9D\\u6B21\\u8A08\\u8CBB), \\u6216\\u8005 LB \\u4F9D\\u8ACB\\u6C42\\u6B21\\u6578\\u8A08\\u8CBB, \\u5982\\u679C\\u80FD\\u5728\\u907F\\u514D\\u8CC7\\u6E90\\u9913\\u6B7B\\u7684\\u524D\\u63D0\\u4E0B\\u4F5C\\u8003\\u91CF\\u6642, \\u90A3\\u9EBC\\u5927\\u90E8\\u5206\\u7684\\u8ACB\\u6C42\\u88AB\\u62D2\\u7D55\\u6642, \\u81EA\\u7136\\u800C\\u7136\\u4EE5\\u4E0A\\u7684\\u6210\\u672C\\u6703\\u4E0B\\u964D\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u9632\\u6B62\\u8D85\\u8F09: \\u6703\\u6253\\u8ACB\\u6C42\\u7684\\u672A\\u5FC5\\u53EA\\u662F\\u4EBA\\u9084\\u6709Bot, \\u70BA\\u4E86\\u907F\\u514D\\u5927\\u5BB6\\u628A\\u6709\\u9650\\u8CC7\\u6E90\\u7684\\u670D\\u52D9\\u5668\\u6253\\u66B4\\u70BA\\u524D\\u63D0\\u505A\\u8A2D\\u8A08 (\\u66F4\\u591A\\u80FD\\u53C3\\u8003SLA)\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u76EE\\u6A19\\uFF1A\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"server-side API rate limiter\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"REF: client: axios-rate-limit: other will be delayed automatically.\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"a large number of requests --> Low latency & little memory\\uFF1F\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u805A\\u5408\\u7528\\u7684\\u6B04\\u4F4D, \\u5E0C\\u671B\\u8DB3\\u5920\\u5F48\\u6027\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"exception handling, inform users\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"service (API Gateway) vs server-side code\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"work in distributed environment, \\u5728\\u9019\\u88E1\\u6307\\u7684\\u662F Rate limiter \\u672C\\u8EAB\\u53EF\\u80FD\\u4E0D\\u53EA\\u662F cluster, \\u751A\\u81F3\\u8DE8 VPC, \\u8DE8 AZ \\u7684\\u74B0\\u5883\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"high fault tolerance: Rate limiter \\u672C\\u8EAB\\u975E\\u696D\\u52D9\\u6D41\\u7A0B\\u4E0A\\u7684\\u5FC5\\u8981\\u529F\\u80FD, \\u5B83\\u672C\\u8EAB\\u7684\\u597D\\u58DE\\u4E0D\\u8A72\\u5F71\\u97FF\\u5230\\u6574\\u500B\\u7CFB\\u7D71, \\u56E0\\u6B64\\u8003\\u91CF\\u6642, \\u8A72\\u600E\\u8A2D\\u8A08\\u9694\\u96E2 rate limte service \\u67D0\\u500B\\u7BC0\\u9EDE\\u7570\\u5E38\\u7684\\u90E8\\u4EFD\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"low latency: rate limit\\u672C\\u8EAB\\u975E\\u696D\\u52D9\\u6240\\u9700\\u529F\\u80FD, \\u4E0D\\u61C9\\u8A72\\u5728latency\\u4E0A\\u4F54\\u6BD4\\u904E\\u9AD8\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"technology stack\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"algorithm \\u53EF\\u9078\\u6027\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6642\\u9593\\u6210\\u672C\"))))), mdx(\"h2\", {\n    \"id\": \"-algorithm\"\n  }, \"# Algorithm\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6F14\\u7B97\\u6CD5\\u4ECB\\u7D39\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Token bucket\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Leaking bucket\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Fixed window counter\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Sliding window log\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u53EF\\u5728\\u6BCF\\u6B21\\u6536\\u5230\\u8ACB\\u6C42\\u6642\\uFF0C\\u624D\\u6E05\\u9664\\u820A\\u8CC7\\u6599\\u3002\\u5B89\\u6392\\u56FA\\u5B9A\\u6642\\u9593\\u6216\\u9577\\u5EA6\\u6E05\\u9664\")), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Q: \\u70BA\\u4EC0\\u9EBC\\u9023\\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\u4E5F\\u8981\\u52A0\\u5165 log \\u505A\\u8A08\\u6578\\uFF1F\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"A: \\u9019\\u500B\\u7684\\u8A2D\\u8A08\\u5176\\u5BE6\\u4E0D\\u662F\\u70BA\\u4E86\\u76F4\\u63A5\\u7D66 rate limiter \\u4F86\\u8A08\\u7B97\\u7528\\u7684\\uFF0C\\u800C\\u662F\\u5176\\u4ED6\\u9700\\u6C42\\uFF0C\\u7562\\u7ADF\\u53EB\\u505A log\\uFF0C\\u50CF nginx access log \\u4E00\\u6A23\\uFF0C\\u6709\\u8ACB\\u6C42\\u4F86\\u7684\\u672C\\u4F86\\u5C31\\u90FD\\u6703\\u88AB\\u7D00\\u9304\\uFF0C\\u6709\\u4EE5\\u4E0B\\u56DB\\u500B\\u5E38\\u898B\\u9700\\u6C42\\uFF1A\"), mdx(\"ol\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u6545\\u969C\\u6392\\u67E5\\u7528: \\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\u53EF\\u80FD\\u8868\\u793A\\u7CFB\\u7D71\\u4E2D\\u5B58\\u5728\\u554F\\u984C\\u3002\\u4F8B\\u5982\\uFF0C\\u5982\\u679C\\u51FA\\u73FE\\u8A31\\u591A\\u8ACB\\u6C42\\u88AB\\u62D2\\u7D55\\uFF0C\\u53EF\\u80FD\\u610F\\u5473\\u8457\\u7CFB\\u7D71\\u8D85\\u8CA0\\u8377\\u3001\\u6709 bug\\u3001\\u6216\\u8005\\u8CC7\\u6E90\\u5206\\u914D\\u4E0D\\u8DB3\\u3002\\u900F\\u904E\\u8A18\\u9304\\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\uFF0C\\u5DE5\\u7A0B\\u5E2B\\u80FD\\u5920\\u56DE\\u6EAF\\u554F\\u984C\\u4E26\\u9032\\u884C\\u4FEE\\u5FA9\\u3002\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u76E3\\u63A7\\u7CFB\\u7D71\\u8CA0\\u8F09: \\u5927\\u91CF\\u7684\\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\u53EF\\u80FD\\u8868\\u793A\\u7CFB\\u7D71\\u8CA0\\u8F09\\u904E\\u9AD8\\u6216\\u8005\\u8CC7\\u6E90\\u77ED\\u7F3A\\u3002\\u9019\\u4E9B\\u65E5\\u8A8C\\u53EF\\u4EE5\\u4F5C\\u70BA\\u6211\\u5011\\u76E3\\u63A7\\u7CFB\\u7D71\\u72C0\\u614B\\u548C\\u8A55\\u4F30\\u8CC7\\u6E90\\u9700\\u6C42\\u7684\\u4F9D\\u64DA\\u3002\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u96E2\\u7DDA\\u7528\\u6236\\u884C\\u70BA\\u5206\\u6790: \\u5C0D\\u65BC\\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\u9032\\u884C\\u8A18\\u9304\\u548C\\u5206\\u6790\\uFF0C\\u53EF\\u4EE5\\u5E6B\\u52A9\\u6211\\u5011\\u66F4\\u597D\\u5730\\u4E86\\u89E3\\u7528\\u6236\\u7684\\u884C\\u70BA\\u6A21\\u5F0F\\uFF0C\\u4EE5\\u53CA\\u90A3\\u4E9B\\u529F\\u80FD\\u6216\\u670D\\u52D9\\u53EF\\u80FD\\u5B58\\u5728\\u554F\\u984C\\u3002\\u7136\\u5F8C\\u6211\\u5011\\u5C31\\u53EF\\u4EE5\\u5C0D\\u9019\\u4E9B\\u554F\\u984C\\u9032\\u884C\\u8ABF\\u6574\\u548C\\u512A\\u5316\\u3002\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u6CD5\\u898F\\u548C\\u5408\\u898F\\u9700\\u6C42: \\u5728\\u67D0\\u4E9B\\u60C5\\u6CC1\\u4E0B\\uFF0C\\u6CD5\\u898F\\u53EF\\u80FD\\u8981\\u6C42\\u6211\\u5011\\u8A18\\u9304\\u6240\\u6709\\u7684\\u8ACB\\u6C42\\uFF0C\\u5305\\u62EC\\u88AB\\u62D2\\u7D55\\u7684\\u8ACB\\u6C42\\u3002\")), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"ref: \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.reddit.com/r/AskComputerScience/comments/xktn2j/rate_limiting_why_log_rejected_requests/\"\n  }, \"Rate limiting - why log rejected requests' timestamps in Sliding window log algorithm?\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Sliding window counter\")))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6F14\\u7B97\\u6CD5\\u6BD4\\u8F03\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Bucket vs Window\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u53EF\\u770B\\u4F5C Bucket \\u53EF\\u4EE5\\u628A\\u53EF\\u63A5\\u53D7\\u7684\\u5CF0\\u503C\\u8DDF\\u5747\\u901F\\u5206\\u958B\\u8A2D\\u5B9A\\uFF0CWindow \\u628A\\u5CF0\\u503C\\u8DDF\\u5747\\u901F\\u7D81\\u5728\\u4E00\\u8D77\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u56E0\\u6B64 Bucket \\u9700\\u8981\\u8ABF\\u6574\\u5169\\u500B\\u53C3\\u6578\\u9054\\u5230\\u5E73\\u8861\\uFF0C\\u4E5F\\u76F8\\u5C0D\\u8F03\\u56F0\\u96E3\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Bucket\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"A. Token bucket\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u9069\\u5408\\u8655\\u7406\\u77AC\\u9593\\u6D41\\u91CF\\uFF0C\\u5982\\u6436\\u8CFC\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u6BD4 B \\u66F4\\u6709\\u6548\\u7684\\u5229\\u7528\\u8CC7\\u6E90\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"B. Leaking bucket\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u7A69\\u5B9A\\u8F38\\u51FA\\u6A21\\u578B\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u4E0D\\u9069\\u5408\\u77AC\\u9593\\u6D41\\u91CF\\uFF0C\\u5982\\u6436\\u8CFC\\u3002\\u56E0\\u70BA\\u5373\\u4F7F\\u6D41\\u91CF\\u5728\\u53EF\\u63A5\\u53D7\\u7BC4\\u570D\\uFF0C\\u4F9D\\u7136\\u6703\\u6309\\u7167\\u4E00\\u500B\\u901F\\u7387\\u9032\\u884C\"))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Window\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"C. Fixed window counter\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u53EF\\u80FD\\u6703\\u6709\\u6642\\u9593\\u5DEE\\u805A\\u96C6\\u73FE\\u8C61\\uFF0C\\u5BE6\\u8CEA\\u4E0A\\u8D85\\u904E\\u6D41\\u91CF\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"D. Sliding window log\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u89E3\\u6C7A C \\u7684\\u554F\\u984C\\uFF0C\\u4E00\\u5B9A\\u4E0D\\u6703\\u8D85\\u904E\\u6D41\\u91CF\\u9650\\u5236\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5927\\u91CF\\u8017\\u8CBB\\u8A18\\u61B6\\u9AD4\\uFF0C\\u56E0\\u70BA\\u9808\\u8A18\\u9304\\u6240\\u6709 timestamp\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u6E05\\u9664\\u820A\\u8CC7\\u6599\\u5F88\\u8017\\u6642\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"E. Sliding window counter\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u89E3\\u6C7A D \\u7684\\u8A18\\u61B6\\u9AD4\\u4F7F\\u7528\\u554F\\u984C\\uFF0C\\u4F46\\u4FDD\\u6709\\u5927\\u6982\\u7387\\u89E3\\u6C7A C \\u7684\\u554F\\u984C\\uFF0C\\u4E0D\\u6703\\u8D85\\u904E\\u6D41\\u91CF\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5BE6\\u9A57\\u7D71\\u8A08\\u53EA\\u6709 0.003% \\u51FA\\u932F\")))))))), mdx(\"h2\", {\n    \"id\": \"-high-level-architecture\"\n  }, \"# High-level architecture\"), mdx(\"h2\", {\n    \"id\": \"-design-deep-dive\"\n  }, \"# Design deep dive\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Rate limiting rules \\u600E\\u88AB\\u5EFA\\u7ACB\\u3001\\u5132\\u5B58\\u3001\\u5B58\\u53D6\\u548C\\u66F4\\u65B0: \\u4F9D\\u7167\\u7D50\\u69CB\\u5316\\u683C\\u5F0F(YAML, JSON, XML...)\\uFF0C\\u5C07\\u898F\\u5247\\u7684\\u6B04\\u4F4D\\u7D66\\u683C\\u5F0F\\u5316\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Exceeding the rate limit\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"HTTP 429 (Too many requests)\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u653E\\u5230\\u5F85\\u8655\\u7406\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u76F4\\u63A5\\u6368\\u68C4\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Rate limiter headers\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6C92\\u8D85\\u904E\\u9650\\u5236\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"X-Ratelimit-Remaining: \\u5728\\u6642\\u9593\\u5340\\u9593\\u5167\\u9084\\u5269\\u4E0B\\u591A\\u5C11\\u914D\\u984D\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"X-Ratelimit-Limit: \\u5728\\u6642\\u9593\\u5340\\u9593\\u5167\\uFF0C\\u5BA2\\u6236\\u7AEF\\u8ACB\\u6C42\\u7684\\u9650\\u984D\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"X-Rate-Limit-Reset: \\u4E00\\u500B\\u4EE3\\u8868\\u6642\\u9593\\u7684\\u6578\\u503C\\uFF0C\\u6642\\u9593\\u5230\\u5C07\\u91CD\\u8A2D\\u914D\\u984D\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u8D85\\u904E\\u9650\\u5236\\u56DE\\u50B3 429\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"X-Ratelimit-Retry-After: \\u6307\\u5B9A\\u5BA2\\u6236\\u7AEF\\u5728\\u50B3\\u9001\\u4E0B\\u4E00\\u500B\\u8981\\u6C42\\u4E4B\\u524D\\u6240\\u61C9\\u7B49\\u5F85 (\\u6216\\u7761\\u7720) \\u7684\\u79D2\\u6578\\u3002\\u5982\\u679C\\u91CD\\u8A66\\u503C\\u6C92\\u904E\\u5C31\\u50B3\\u9001\\u8981\\u6C42\\uFF0C\\u5247\\u4E0D\\u6703\\u8655\\u7406\\u8981\\u6C42\\uFF0C\\u4E26\\u4E14\\u6703\\u56DE\\u50B3\\u65B0\\u7684\\u91CD\\u8A66\\u503C\\u3002\")), mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Client\\u9700\\u8981\\u77E5\\u9053\\u9019\\u4E9B\\u8CC7\\u8A0A\\uFF0C\\u624D\\u597D\\u63A7\\u5236\\u4E0B\\u4E00\\u6B21\\u767C\\u51FA\\u8ACB\\u6C42 (\\u751A\\u81F3\\u4E5F\\u80FD\\u8AAA\\u662F\\u4E00\\u7A2ERetry policy\\u7684\\u63A7\\u5236)\"))))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Detailed design\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Q: \\u9019\\u4E9B\\u8CC7\\u8A0A\\u9069\\u5408\\u5B58\\u653E\\u5728\\u54EA\\uFF1F\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"A: RDBMS\\u592A\\u6162\\u4E14\\u672C\\u8EAB\\u7684\\u8CC7\\u6599\\u7D50\\u69CB\\u4E5F\\u4E0D\\u9069\\u5408\\u5B58\\u653E\\u5927\\u91CF\\u6578\\u64DA\\uFF0C\\u4E14\\u6709\\u71B1\\u9EDE\\u5B58\\u53D6\\u554F\\u984C\\uFF0C\\u56E0\\u6B64\\u9078\\u64C7 in memory store \\u662F\\u9069\\u5408\\u7684\\uFF0C\\u5920\\u5FEB\\u4E14\\u904E\\u671F\\u7684\\u8CC7\\u6599\\u901A\\u5E38 in-memory db \\u6709\\u914D\\u5408\\u7684\\u6A5F\\u5236\\u80FD\\u6C70\\u9664\\u6389\\uFF0C\\u56E0\\u70BA\\u6211\\u5011\\u9019\\u88E1\\u5927\\u90E8\\u5206\\u90FD\\u53EA\\u8981\\u8A08\\u6B21 (sliding window log \\u4F8B\\u5916)\\uFF0CRedis\\u6709\\u63D0\\u4F9BINCR\\u8207EXPIRE (\\u751A\\u81F3TTL\\u6A5F\\u5236)\\uFF0C\\u4FBF\\u65BC\\u4F7F\\u7528\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Rate limiter in a distributed environments\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Race condition (\\u985E\\u4F3C\\u8D85\\u8CE3\\u554F\\u984C)\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Locks\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u6703\\u964D\\u4F4E\\u6548\\u80FD\\uFF0C\\u541E\\u5410\\u91CF\\u6703\\u53D7\\u5F71\\u97FF\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Lua script\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u56E0\\u70BA\\u662F\\u300C\\u539F\\u5B50\\u6027\\u7684\\u300D\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u56E0\\u70BA lock \\u662F\\u5C0D\\u8CC7\\u6E90\\u5C64\\u7D1A\\u7684\\u9396\\u5B9A\\uFF0C\\u9748\\u6D3B\\u6027\\u8F03\\u4F4E\\uFF0C\\u4EE5\\u539F\\u5B50\\u6027\\u7684\\u8173\\u672C\\u4F86\\u505A\\uFF0C\\u80FD\\u5920\\u53EA\\u5728\\u9700\\u8981\\u7684\\u6B65\\u9A5F\\u4E0A\\u4F7F\\u7528\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"sorted sets data structure\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://mecha-mind.medium.com/redis-sorted-sets-and-skip-lists-4f849d188a33\"\n  }, \"Skip List\")))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Synchronization issue\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u5728\\u8DE8 VPC / AZ \\u7684\\u60C5\\u6CC1\\u4E0B\\uFF0C\\u5F88\\u53EF\\u80FD rate limiter \\u5167\\u7684\\u8CC7\\u8A0A\\u8207\\u72C0\\u614B\\u4E0D\\u4E00\\u81F4\\uFF0C\\u5C0D\\u540C\\u4E00\\u500Buser\\uFF0C\\u4E0D\\u540C\\u8ACB\\u6C42\\u6703\\u96A8\\u6A5F\\u8DF3\\u8F49\\u5230\\u4E0D\\u540C rate limiter \\u4E0A\\u88AB\\u8655\\u7406\\uFF0C\\u90A3\\u5C31\\u7B49\\u65BC\\u767D\\u642D\\u4E86\\uFF0C\\u6240\\u4EE5\\u5728\\u9019\\u88E1\\u6703\\u5EFA\\u8B70\\u7528\\u540C\\u4E00\\u500B redis cluster\\uFF0C\\u4EE5\\u53CA\\u555F\\u7528 sticky session\\u6A5F\\u5236\\uFF0C\\u8B93\\u540C\\u4E00\\u500B user \\u7684\\u4E0D\\u540C\\u8ACB\\u6C42\\u90FD\\u80FD\\u5728\\u540C\\u4E00\\u500B rate limiter \\u4E0A\\u88AB\\u8655\\u7406\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"sticky sessions\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u8B93 client \\u53BB\\u56FA\\u5B9A rate limiter\\uFF0C\\u4E0D\\u5F48\\u6027\\u4E0D\\u597D\\u64F4\\u5C55\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"centralized data stores\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"REF: \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://blog.devgenius.io/a-comprehensive-guide-to-distributed-caching-827f1fa5a184\"\n  }, \"A Comprehensive Guide to Distributed Caching\")))))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Performance optimization\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"multi-data center\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"eventual consistency model\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u76F8\\u8F03\\u65BC\\u5B8C\\u5168\\u4E00\\u81F4\\u6027\\u66F4\\u6709\\u6548\\u7387\\uFF0C\\u4F46\\u53C8\\u4FDD\\u6709\\u4E00\\u81F4\\u6027\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"chaper 6\"))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Monitoring\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u9700\\u76E3\\u63A7\\u4EE5\\u4E0B\\u5169\\u500B\\u9762\\u5411\\u662F\\u5426\\u80FD\\u6709\\u6548\\u5730\\u9054\\u5230\\u76EE\\u7684\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"rate limiting rules\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"rate limiting algorithm\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"EX. flash sales --> Token bucket\")))))))), mdx(\"h2\", {\n    \"id\": \"-延伸討論\"\n  }, \"# \\u5EF6\\u4F38\\u8A0E\\u8AD6\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u4E0D\\u540C layer \\u7684\\u9632\\u7BC4\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5728 layer 3 \\u9032\\u884C\\u8F03\\u5FEB\\uFF1F\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5168\\u516C\\u53F8\\u540C\\u4E00\\u500B ip\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u6C92\\u767B\\u5165\\u6642 (\\u4E5F\\u53EF\\u5728 layer 7 \\u7528 session)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u91DD\\u5C0D\\u4E0D\\u540C\\u985E\\u578B\\u4F7F\\u7528\\u8005\\uFF0C\\u4E0D\\u540C\\u7B56\\u7565\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u4E0D\\u540C layer \\u7684\\u9632\\u7BC4\\uFF0C\\u4E0D\\u662F\\u9078\\u64C7\\uFF0C\\u800C\\u662F\\u4E00\\u8D77\\u7528\\uFF0C\\u5404\\u81EA\\u9632\\u4E0D\\u540C\\u9762\\u5411\\u3002\\u4F46\\u7528\\u592A\\u591A\\u6703\\u4E0D\\u6703\\u5F71\\u97FF\\u5230\\u55AE\\u6B21\\u8ACB\\u6C42\\u7684\\u6548\\u80FD\\uFF1F\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u52A0\\u5F37 client\\uFF0C\\u907F\\u514D\\u554F\\u984C\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"client cache\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5408\\u7406\\u7684\\u767C\\u9001\\u8ACB\\u6C42\\uFF1F\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"catch exceptions or errors\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"back off time\\uFF1A\\u53EF\\u7528\\u6307\\u6578\\u578B\\u6210\\u9577\\u7B56\\u7565\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Hard vs Soft\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Hard rate limiting\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u8D85\\u904E\\u9650\\u5236\\u7684\\u8ACB\\u6C42\\u5C07\\u88AB\\u76F4\\u63A5\\u62D2\\u7D55\\u6216\\u8FD4\\u56DE\\u932F\\u8AA4\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u78BA\\u4FDD\\u7CFB\\u7D71\\u5728\\u7279\\u5B9A\\u6642\\u9593\\u5167\\u4E0D\\u6703\\u8D85\\u904E\\u9810\\u5B9A\\u7684\\u8ACB\\u6C42\\u901F\\u7387\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u53EF\\u80FD\\u5C0E\\u81F4\\u5BA2\\u6236\\u7AEF\\u9AD4\\u9A57\\u4E0D\\u4F73\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Soft rate limiting\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5141\\u8A31\\u77ED\\u671F\\u5167\\u8D85\\u904E\\u9650\\u5236\\u7684\\u8ACB\\u6C42\\uFF0C\\u4F46\\u5728\\u9577\\u671F\\u5167\\u7DAD\\u6301\\u5E73\\u5747\\u901F\\u7387\\u4E0D\\u8D85\\u904E\\u9810\\u5B9A\\u7684\\u9650\\u5236\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u901A\\u5E38\\u4F7F\\u7528 Bucket \\u6F14\\u7B97\\u6CD5\"))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u7576\\u670D\\u52D9\\u5668\\u300C\\u7E3D\\u8CA0\\u8F09\\u300D\\u5FEB\\u8981\\u8D85\\u51FA\\u9650\\u984D\\uFF0C\\u6703\\u600E\\u9EBC\\u505A\\uFF1F\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5E73\\u5747\\u8ABF\\u4F4E rate limit threshold\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u628A\\u6D41\\u91CF\\u7559\\u7D66\\u91CD\\u8981\\u7684\\u8ACB\\u6C42\\u6216\\u7528\\u6236\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5927\\u5BB6\\u90FD\\u66AB\\u505C\\u5225\\u7528\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u6A5F\\u5668\\u958B\\u4E0B\\u53BB\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5176\\u4ED6\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Circuit breaking\\uFF08\\u7194\\u65B7\\uFF09\\u548C degradation\\uFF08\\u964D\\u7D1A\\uFF09\"))));\n}\n;\nMDXContent.isMDXComponent = true;","rawBody":"# 第四章：設計網路限速器\n\n## # 主軸\n\n- 主要在 Layer 7: Application layer\n\n- 作用：\n\n  - 防止 DoS: 避免資源餓死 (resouce starvation)\n  - 節省流量成本: 流程內可能會調用到第三方服務 (依次計費), 或者 LB 依請求次數計費, 如果能在避免資源餓死的前提下作考量時, 那麼大部分的請求被拒絕時, 自然而然以上的成本會下降\n  - 防止超載: 會打請求的未必只是人還有Bot, 為了避免大家把有限資源的服務器打暴為前提做設計 (更多能參考SLA)\n\n- 目標：\n\n  - server-side API rate limiter\n\n    - REF: client: axios-rate-limit: other will be delayed automatically.\n\n  - a large number of requests --> Low latency & little memory？\n \n  - 聚合用的欄位, 希望足夠彈性\n\n  - exception handling, inform users\n\n  - service (API Gateway) vs server-side code\n\n  - work in distributed environment, 在這裡指的是 Rate limiter 本身可能不只是 cluster, 甚至跨 VPC, 跨 AZ 的環境\n\n  - high fault tolerance: Rate limiter 本身非業務流程上的必要功能, 它本身的好壞不該影響到整個系統, 因此考量時, 該怎設計隔離 rate limte service 某個節點異常的部份\n \n  - low latency: rate limit本身非業務所需功能, 不應該在latency上佔比過高\n\n  - technology stack\n\n  - algorithm 可選性\n\n  - 時間成本\n\n## # Algorithm\n\n- 演算法介紹\n\n  - Token bucket\n\n  - Leaking bucket\n\n  - Fixed window counter\n\n  - Sliding window log\n\n    - 可在每次收到請求時，才清除舊資料。安排固定時間或長度清除\n    \n    Q: 為什麼連被拒絕的請求也要加入 log 做計數？\n    \n    A: 這個的設計其實不是為了直接給 rate limiter 來計算用的，而是其他需求，畢竟叫做 log，像 nginx access log 一樣，有請求來的本來就都會被紀錄，有以下四個常見需求：\n    \n       1. 故障排查用: 被拒絕的請求可能表示系統中存在問題。例如，如果出現許多請求被拒絕，可能意味著系統超負荷、有 bug、或者資源分配不足。透過記錄被拒絕的請求，工程師能夠回溯問題並進行修復。\n       2. 監控系統負載: 大量的被拒絕的請求可能表示系統負載過高或者資源短缺。這些日誌可以作為我們監控系統狀態和評估資源需求的依據。\n       3. 離線用戶行為分析: 對於被拒絕的請求進行記錄和分析，可以幫助我們更好地了解用戶的行為模式，以及那些功能或服務可能存在問題。然後我們就可以對這些問題進行調整和優化。\n       4. 法規和合規需求: 在某些情況下，法規可能要求我們記錄所有的請求，包括被拒絕的請求。\n    \n    ref: [Rate limiting - why log rejected requests' timestamps in Sliding window log algorithm?](https://www.reddit.com/r/AskComputerScience/comments/xktn2j/rate_limiting_why_log_rejected_requests/)\n\n  - Sliding window counter\n\n- 演算法比較\n\n  - Bucket vs Window\n\n    - 可看作 Bucket 可以把可接受的峰值跟均速分開設定，Window 把峰值跟均速綁在一起\n    - 因此 Bucket 需要調整兩個參數達到平衡，也相對較困難\n\n  - Bucket\n\n    - A. Token bucket\n\n      - 適合處理瞬間流量，如搶購\n      - 比 B 更有效的利用資源\n\n    - B. Leaking bucket\n\n      - 穩定輸出模型\n      - 不適合瞬間流量，如搶購。因為即使流量在可接受範圍，依然會按照一個速率進行\n\n  - Window\n\n    - C. Fixed window counter\n\n      - 可能會有時間差聚集現象，實質上超過流量\n\n    - D. Sliding window log\n\n      - 解決 C 的問題，一定不會超過流量限制\n      - 大量耗費記憶體，因為須記錄所有 timestamp\n      - 清除舊資料很耗時\n\n    - E. Sliding window counter\n\n      - 解決 D 的記憶體使用問題，但保有大概率解決 C 的問題，不會超過流量\n      - 實驗統計只有 0.003% 出錯\n\n## # High-level architecture\n\n## # Design deep dive\n\n- Rate limiting rules 怎被建立、儲存、存取和更新: 依照結構化格式(YAML, JSON, XML...)，將規則的欄位給格式化\n\n- Exceeding the rate limit\n\n  - HTTP 429 (Too many requests)\n\n    - 放到待處理\n    - 直接捨棄\n\n  - Rate limiter headers\n\n    - 沒超過限制\n\n      - X-Ratelimit-Remaining: 在時間區間內還剩下多少配額\n      - X-Ratelimit-Limit: 在時間區間內，客戶端請求的限額\n      - X-Rate-Limit-Reset: 一個代表時間的數值，時間到將重設配額\n\n    - 超過限制回傳 429\n\n      - X-Ratelimit-Retry-After: 指定客戶端在傳送下一個要求之前所應等待 (或睡眠) 的秒數。如果重試值沒過就傳送要求，則不會處理要求，並且會回傳新的重試值。\n     \n      **Client需要知道這些資訊，才好控制下一次發出請求 (甚至也能說是一種Retry policy的控制)**\n\n- Detailed design\n\n  Q: 這些資訊適合存放在哪？\n  \n  A: RDBMS太慢且本身的資料結構也不適合存放大量數據，且有熱點存取問題，因此選擇 in memory store 是適合的，夠快且過期的資料通常 in-memory db 有配合的機制能汰除掉，因為我們這裡大部分都只要計次 (sliding window log 例外)，Redis有提供INCR與EXPIRE (甚至TTL機制)，便於使用\n\n- Rate limiter in a distributed environments\n\n  - Race condition (類似超賣問題)\n\n    - Locks\n\n      - 會降低效能，吞吐量會受影響\n\n    - Lua script\n\n      - 因為是「原子性的」\n      - 因為 lock 是對資源層級的鎖定，靈活性較低，以原子性的腳本來做，能夠只在需要的步驟上使用\n\n    - sorted sets data structure\n\n      - [Skip List](https://mecha-mind.medium.com/redis-sorted-sets-and-skip-lists-4f849d188a33)\n\n  - Synchronization issue\n \n    在跨 VPC / AZ 的情況下，很可能 rate limiter 內的資訊與狀態不一致，對同一個user，不同請求會隨機跳轉到不同 rate limiter 上被處理，那就等於白搭了，所以在這裡會建議用同一個 redis cluster，以及啟用 sticky session機制，讓同一個 user 的不同請求都能在同一個 rate limiter 上被處理\n\n    - sticky sessions\n\n      - 讓 client 去固定 rate limiter，不彈性不好擴展\n\n    - centralized data stores\n\n      - REF: [A Comprehensive Guide to Distributed Caching](https://blog.devgenius.io/a-comprehensive-guide-to-distributed-caching-827f1fa5a184)\n\n- Performance optimization\n\n  - multi-data center\n  - eventual consistency model\n    - 相較於完全一致性更有效率，但又保有一致性\n    - chaper 6\n\n- Monitoring\n\n  - 需監控以下兩個面向是否能有效地達到目的\n\n    - rate limiting rules\n    - rate limiting algorithm\n      - EX. flash sales --> Token bucket\n\n## # 延伸討論\n\n- 不同 layer 的防範\n\n  - 在 layer 3 進行較快？\n  - 全公司同一個 ip\n  - 沒登入時 (也可在 layer 7 用 session)\n  - 針對不同類型使用者，不同策略\n  - 不同 layer 的防範，不是選擇，而是一起用，各自防不同面向。但用太多會不會影響到單次請求的效能？\n\n- 加強 client，避免問題\n\n  - client cache\n  - 合理的發送請求？\n  - catch exceptions or errors\n  - back off time：可用指數型成長策略\n\n- Hard vs Soft\n\n  - Hard rate limiting\n\n    - 超過限制的請求將被直接拒絕或返回錯誤\n    - 確保系統在特定時間內不會超過預定的請求速率\n    - 可能導致客戶端體驗不佳\n\n  - Soft rate limiting\n\n    - 允許短期內超過限制的請求，但在長期內維持平均速率不超過預定的限制\n    - 通常使用 Bucket 演算法\n\n- 當服務器「總負載」快要超出限額，會怎麼做？\n\n  - 平均調低 rate limit threshold\n  - 把流量留給重要的請求或用戶\n  - 大家都暫停別用\n  - 機器開下去\n  - 其他\n\n- Circuit breaking（熔斷）和 degradation（降級）\n","excerpt":"第四章：設計網路限速器 # 主軸 主要在 Layer 7: Application layer 作用： 防止 DoS: 避免資源餓死 (resouce starvation) 節省流量成本: 流程內可能會調用到第三方服務 (依次計費), 或者 LB 依請求次數計費, 如果能在避…","outboundReferences":[],"inboundReferences":[]},"tagsOutbound":{"nodes":[]}},"pageContext":{"tags":[],"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4/","sidebarItems":[{"title":"Categories","items":[{"title":"Content","url":"","items":[{"title":"Domain-Driven-Design","url":"","items":[{"title":"Domain-Modeling-Made-Functional","url":"/content/domain-driven-design/domain-modeling-made-functional/","items":[{"title":"Chapter-1","url":"","items":[{"title":"Domain Driven Design Made Functional","url":"/content/domain-driven-design/domain-modeling-made-functional/chapter-1/chpater_1/","items":[]}]}]}]},{"title":"Front-End","url":"","items":[{"title":"微前端","url":"/content/front-end/micro-frontend/","items":[]}]},{"title":"System-Design","url":"","items":[{"title":"System-Design-Interview-Alex-Xu-Volume1","url":"/content/system-design/system-design-interview-alex-xu-volume1/","items":[{"title":"Chapter-1","url":"","items":[{"title":"第一章：使用者人數 -- 從零到百萬規模","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-1/chapter_1/","items":[]}]},{"title":"Chapter-10","url":"","items":[{"title":"Demo","url":"","items":[{"title":"React + TypeScript + Vite","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-10/demo/client/","items":[]}]},{"title":"design pattern (notification)","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-10/chapter_10/","items":[]}]},{"title":"Chapter-4","url":"","items":[{"title":"第四章：設計網路限速器","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-4/chapter_4/","items":[]}]},{"title":"Chapter-7","url":"","items":[{"title":"第七章：設計可用於分散式系統的唯一 ID 生成器","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-7/chapter_7/","items":[]}]},{"title":"Chapter-8","url":"","items":[{"title":"第八章：設計短網址生成器","url":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-8/chapter_8/","items":[]}]}]}]}]},{"title":"software-engineering-book-club","url":"/","items":[]}]}],"tagsGroups":[],"latestPosts":[{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/","title":"System-Design-Interview-Alex-Xu-Volume1","lastUpdatedAt":"2023-10-22T13:09:03.000Z","lastUpdated":"10/22/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-10/chapter_10/","title":"design pattern (notification)","lastUpdatedAt":"2023-09-02T03:25:17.000Z","lastUpdated":"9/2/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-10/demo/client/","title":"React + TypeScript + Vite","lastUpdatedAt":"2023-09-02T03:25:17.000Z","lastUpdated":"9/2/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/domain-driven-design/domain-modeling-made-functional/chapter-1/chpater_1/","title":"Domain Driven Design Made Functional","lastUpdatedAt":"2023-07-30T09:05:36.000Z","lastUpdated":"7/30/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-8/chapter_8/","title":"第八章：設計短網址生成器","lastUpdatedAt":"2023-07-28T02:25:02.000Z","lastUpdated":"7/28/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-7/chapter_7/","title":"第七章：設計可用於分散式系統的唯一 ID 生成器","lastUpdatedAt":"2023-07-07T03:07:23.000Z","lastUpdated":"7/7/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/","title":"software-engineering-book-club","lastUpdatedAt":"2023-07-06T14:43:04.000Z","lastUpdated":"7/6/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/domain-driven-design/domain-modeling-made-functional/","title":"Domain-Modeling-Made-Functional","lastUpdatedAt":"2023-07-06T07:45:19.000Z","lastUpdated":"7/6/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/front-end/micro-frontend/","title":"微前端","lastUpdatedAt":"2023-07-05T02:50:46.000Z","lastUpdated":"7/5/2023"},"frontmatter":{"draft":false,"tags":[]}},{"fields":{"slug":"/content/system-design/system-design-interview-alex-xu-volume1/chapter-1/chapter_1/","title":"第一章：使用者人數 -- 從零到百萬規模","lastUpdatedAt":"2023-06-22T13:53:44.000Z","lastUpdated":"6/22/2023"},"frontmatter":{"draft":false,"tags":[]}}]}},
    "staticQueryHashes": ["2230547434","2320115945","3495835395","451533639"]}